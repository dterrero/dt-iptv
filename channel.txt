import os
import subprocess

# Path to your channel source text files
SOURCE_DIR = "/opt/iptv/sources/"
# Path where the NGINX map will be saved
MAP_FILE_PATH = "/etc/nginx/conf.d/channel_map.map"

channels_map = []

# 1. Loop through every .txt file in your source folder
for filename in os.listdir(SOURCE_DIR):
    if filename.endswith(".txt"):
        channel_name = filename.replace(".txt", "")
        with open(os.path.join(SOURCE_DIR, filename), "r") as f:
            lines = f.read().splitlines()
            if len(lines) >= 1:
                # The script assumes the first line is the latest scraped .m3u8 URL
                current_m3u8 = lines[0]
                # Format for NGINX map:  /relative/path  "https://full-source-url";
                channels_map.append(f"~^/streams/{channel_name}/ \"{current_m3u8}\";")

# 2. Write the NGINX Map file
with open(MAP_FILE_PATH, "w") as f:
    f.write("map $uri $backend_url {\n")
    f.write("    default \"http://127.0.0.1/error\";\n")
    f.write("\n".join(channels_map))
    f.write("\n}\n")

# 3. Tell NGINX to reload the new map (no downtime)
subprocess.run(["sudo", "nginx", "-s", "reload"])
print(f"Updated {len(channels_map)} channels in NGINX map.")
