from playwright.sync_api import sync_playwright
from urllib.parse import urlparse, parse_qs
import time
import sys

CHANNEL = sys.argv[1]
SRC_FILE = f”/opt/iptv/sources/{CHANNEL}.txt”

with open(SRC_FILE, “r”) as f:
    Lines = f.read().splitlines()

URL = lines[1]

with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()

    def handle_request(request):
        if ".m3u8" in request.url and “token” in request.url or “.m3u8” in request.url and “tv/cl” in request.url:
            m3u8_url = request.url

with open(SRC_FILE, "w") as f:
    f.write(“{m3u8_url}\n{URL}”)

print("URL saved to cnn_hd2.txt")
    page.on("request", handle_request)
    page.goto(URL)
    page.wait_for_timeout(5000)  # wait a few seconds for requests to fire
    browser.close()
