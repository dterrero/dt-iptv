server {
    listen 80;
    server_name _;

    location ~ ^/streams/(?<channel>[^/]+)(/?(?<suffix>.*))$ {
        resolver 8.8.8.8;

        # 1. Masking headers for the provider
        proxy_set_header Host livetvde.net;
        proxy_set_header Referer "https://www.livehdtv.com/";
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
    
        # 2. Prevent compression so Nginx can read the text
        proxy_set_header Accept-Encoding ""; 

        # 3. The Path Fixer (THIS IS THE KEY)
        # This turns "2026/01/..." into "https://livetvde.net/cusa/tracks-v1a1/2026/01/..."
        sub_filter_types *;
        sub_filter_once off;
    
        # We must replace the start of the relative path with the absolute provider path
        # NOTE: You may need to adjust the '/cusa/tracks-v1a1/' part based on the channel
        sub_filter '2026/' 'https://livetvde.net/cusa/tracks-v1a1/2026/';

        proxy_pass $backend_url$suffix$is_args$args;
        proxy_ssl_server_name on;
        proxy_ssl_name livetvde.net;
    }
}
